{% extends 'layout.html' %}

{% block content %}

{% if user %}
<div id="upload-content">
<form action="/post" method="post">
<textarea name="content" rows="4" cols="70"></textarea>
<div id="img-preview">
<img src="" />
<input type="hidden" id="img-url" name="url"/>
</div>
<div>
<input type="file" id="upload-img"/>
<label for="upload-img" accept="image/*">ì‚¬ì§„ ì—…ë¡œë“œ</label>
<button type="submit" id="btn-post-upload">ì§¹ì§¹</button>
</div>
</form>
</div>
{% endif %}

<div id="post-list">
{% for twit in twits %}
<div class="post">
{% if user.id === twit.User.id %}
<p>ë‹¹ì‹ ì˜ í¬ìŠ¤íŠ¸
<button class="btn-delete-post" data-id="{{ twit.id }}">íŠ¸ìœ— ì‚­ì œ</button>
<span>{{ twit.Likes.length }}</span>
</p>
{% else %}
<p>{{ twit.User.nick }}ë‹˜ì˜ í¬ìŠ¤íŠ¸
{% if not followerIdList.includes(twit.User.id) %}
<button class="btn-follow" data-id="{{ twit.User.id }}" >íŒ”ë¡œìš° í•˜ê¸°</button>
{% else %}
<button class="btn-follow-delete" data-id="{{ twit.User.id }}" >íŒ”ë¡œìš° ì·¨ì†Œ</button>
{% endif %}
{% if checkLiker(twit, user.id) %}
<button class="btn-like-delete" data-id="{{ twit.id }}" >ğŸ‘</button>
{% else %}
<button class="btn-like" data-id="{{ twit.id }}" >ğŸ‘</button>
{% endif %}
<span>{{ twit.Likes.length }}</span>
</p>
{% endif %}
<p>{{ twit.content }}</p>
{% if twit.img %}
<img src="{{ twit.img }}" />
{% endif %}
</div>

{% endfor %}
</div>
{% endblock %}


{% block script %}
<script>

$('#upload-img').on('change', (e) => {
    const img = e.target.files[0];
    const formData = new FormData();
    formData.append('img', img);
    axios.post('/post/img', formData)
        .then((res) => {
            console.log($('#img-preview').find('img'));
            $('#img-preview').find('img').attr('src', res.data.url);
            $('#img-url').val(res.data.url);
        })

});

$('.btn-follow').on('click', (e) => {
    axios.post(`/user/${ e.target.dataset.id }/follow`)
        .then(() => {
            location.reload();
            alert('íŒ”ë¡œìš° ì™„ë£Œ');
        })
        .catch((e) => {
            if(e.response.status === 403){
                alert('ë¡œê·¸ì¸ í•„ìš”!');
            }
        });
});

$('.btn-follow-delete').on('click', (e) => {
    axios.delete(`/user/${ e.target.dataset.id }/follow`)
        .then(() => {
            location.reload();
            alert('íŒ”ë¡œìš° ì·¨ì†Œ');
        })
        .catch((e) => {
            if(e.response.status === 403){
                alert('ë¡œê·¸ì¸ í•„ìš”!');
            }
        });
});

$('.btn-delete-post').on('click', (e) => {
    axios.delete(`/post/${ e.target.dataset.id }`)
        .then(() => {
            location.reload();
            alert('íŠ¸ìœ— ì‚­ì œ');
        })
        .catch((e) => {
            if(e.response.status === 403){
                alert('ë¡œê·¸ì¸ í•„ìš”!');
            }
        });
});

$('.btn-like').on('click', (e) => {
    axios.get(`/post/${e.target.dataset.id}/like`)
        .then(() => {
            location.reload();
            alert('ì¢‹ì•„ìš”'); 
        })
        .catch((e) => {
            if(e.response.status === 403){
                alert('ë¡œê·¸ì¸ í•„ìš”!');
            }
        })
})

$('.btn-like-delete').on('click', (e) => {
    axios.delete(`/post/${e.target.dataset.id}/like`)
        .then(() => {
            location.reload();
            alert('ì¢‹ì•„ìš” ì·¨ì†Œ'); 
        })
        .catch((e) => {
            if(e.response.status === 403){
                alert('ë¡œê·¸ì¸ í•„ìš”!');
            }
        })
})
</script>
{% endblock %}

<!-- ë©”ì¸ì°½ ì¶œë ¥ -->